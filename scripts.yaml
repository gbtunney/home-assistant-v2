llm_vision_describe_scene:
  alias: LLM Vision Describe Scene
  description: 'LLM Vision: Describe the Camera Feed in Sentence'
  fields:
    prompt:
      selector:
        text:
      name: prompt
      required: true
      default: "\"Summarize what's happening in the camera feed (one sentence max).\n
        Don't describe the scene! If there is a person, describe what they're\n doing
        and what they look like. If they look like a courier mention that!\n If nothing
        is happening, say so.\"\n"
  sequence:
  - variables:
      llv_response: undefined
  - action: llmvision.image_analyzer
    metadata: {}
    data:
      include_filename: false
      target_width: 800
      detail: low
      max_tokens: 100
      temperature: 0.5
      provider: 01JDVNFP4KWD6XERDGQ5V3TY6W
      message: '{{ prompt }}'
      remember: false
      expose_images: false
      image_file: /media/{{ states( 'input_text.url_llv')  }}
    response_variable: llv_response
  - action: input_text.set_value
    metadata: {}
    data:
      value: '{{ llv_response }}'
    target:
      entity_id: input_text.llm_response
  icon: mdi:camera
llv_prompt_test:
  alias: LLV Prompt Test
  fields:
    prompt:
      selector:
        text:
      name: prompt
      required: true
  sequence:
  - metadata: {}
    data:
      max_tokens: 100
      model: gpt-4o
      provider: 01J99F4T99PA1XGQ4CTQS3CP8H
      target_width: 1280
      include_filename: false
      image_entity:
      - camera.front_door
      - camera.garage
      message: '{{ prompt }}'
    response_variable: response
    action: llmvision.image_analyzer
  - metadata: {}
    data:
      cache: true
      media_player_entity_id: media_player.entity_id
      message: '{{response.response_text}}'
    target:
      entity_id: tts.piper
    action: tts.speak
  description: ''
llv_numeric_question:
  alias: LLV Numeric Question
  sequence:
  - variables:
      camera_image_file: undefined
      test_count: 0
  - action: script.camera_snapshot_and_upload
    metadata: {}
    data:
      capture_camera_stream:
        entity_id: '{{capture_camera_stream.entity_id }}'
      capture_mime_type: image/png
    response_variable: camera_image_file
  - action: llmvision.data_analyzer
    metadata: {}
    data:
      message: '{{ questions_prompt }}'
      include_filename: false
      target_width: 1280
      detail: high
      max_tokens: 5
      temperature: 0.1
      provider: 01JDVNFP4KWD6XERDGQ5V3TY6W
      sensor_entity: '{{ file_path_save_target.entity_id }}'
      image_file: '{{camera_image_file.media_rel }}'
  description: ''
  fields:
    questions_prompt:
      selector:
        text:
      name: Questions Prompt
      default: Can you count the pictures on the wall ?
      required: true
    file_path_save_target:
      selector:
        target:
          entity:
            domain: input_number
      name: File Path Save Target
      required: true
      description: Input text entity to save the file path to
    capture_camera_stream:
      selector:
        target:
          entity:
            domain: camera
      name: Camera Stream
      default:
        entity_id: camera.camera_1_q5_profile1
      required: true
purge_logbook_by_entiity:
  alias: Purge Logbook by Entiity
  sequence:
  - action: recorder.purge_entities
    metadata: {}
    data:
      domains:
      - logbook
      entity_globs: '{{target_entities.entity_id}}'
    enabled: false
  fields:
    target_entities:
      selector:
        target:
      name: Target Entities to purge
      required: true
  description: ''
api_adapter_notification_dispatcher:
  sequence:
  - alias: Set up variables
    variables:
      target_notification_channel: '{{notification_channel_list.split('','') }}'
      notification_channel_count: '{{target_notification_channel |  list | count }}'
      action_callback: '{{callback}}'
    enabled: false
  - action: script.notification_dispatcher_ui
    metadata: {}
    data:
      message: '{{message}}'
      notification_channel:
      - persistant
      - alexa
      alexa_sound: amzn_sfx_doorbell_01
  mode: restart
  alias: API Adapter Notification Dispatcher
  description: ''
  fields: {}
alexa_test_service:
  sequence:
  - action: script.custom_alexa_notification
    metadata: {}
    data:
      target_alexa_speaker:
        entity_id: media_player.alexa_s_baby
      message: 'No message set. '
      volume: Normal Volume
      sound: buzzers_pistols_01
  alias: Alexa Test Service
  description: ''
test_response:
  sequence:
  - variables:
      value: '{{number_to_add | int }}'
      test_response_var:
        value_plus_five: '{{  value + 5}}

          '
      value_plus_five: '{{  value |int + 5 }}

        '
  - sequence: []
  - action: logbook.log
    metadata: {}
    data:
      name: script.test_response
      message: '{{ test_response_var | to_json}}'
  - stop: '''returning value + 5'''
    response_variable: test_response_var
  alias: Test Response
  description: ''
  fields:
    testvalue:
      selector:
        text:
      name: testvalue
      default: this is the default
    number_to_add:
      selector:
        number:
          min: 1
          max: 100
      name: number to add
      default: 37
      required: true
test_parent_resp:
  sequence:
  - variables:
      result: not set yet!
  - action: script.test_response
    data:
      testvalue: i am a value
      number_to_add: 100
    response_variable: result
  - action: logbook.log
    metadata: {}
    data:
      name: LogBook test response
      message: RESULT Child Script {{result}}
  alias: Test Parent Resp
  description: ''
alert_replacement_script_ui:
  sequence:
  - variables:
      resolved:
        alert_name: '{{alert_name}}'
        label_id: '{{label_id}}'
        controlling_timer: '{{notification_timer}}'
        controlling_binary_sensor: '{{controlling_binary_sensor}}'
        alert_type: '{{alert_type}}'
        event_uid: '{{event_uid}}'
      controlling_sensor_state: '{{ bool( is_state(resolved.controlling_binary_sensor
        ,[''on''] ) )}}'
      controlling_timer_state: '{{ states( resolved.controlling_timer) }}'
      error: '{{ bool( is_state(resolved.controlling_binary_sensor ,[''unavailable'',''unknown'']
        ),false  ) or  bool( is_state(resolved.controlling_timer,[''unavailable'',''unknown'']
        ),false  )}}'
  - choose:
    - conditions:
      - alias: Send Notification and Start Timer
        condition: template
        value_template: '{{ bool(controlling_sensor_state, false) and not bool(controlling_timer_state
          in [''paused''], false) }}'
      sequence:
      - variables:
          message: "{% set label_list = label_entities(resolved.label_id) | select('is_state',
            'off') | list %}    \n{%- for entity_id in label_list -%}\n  {% set entity_name
            = state_attr(entity_id, \"friendly_name\") %}\n  {% set entity_area_name
            = area_name(entity_id) %}\n  {% if entity_area_name is none %}\n    {%
            set device_id = device_id(entity_id) %}\n    {% set entity_area_name =
            area_name(device_id) %}\n  {% endif %}\n  Entity {{ entity_name }} in
            Area: {{ entity_area_name }} has been off for {{ relative_time(states[entity_id].last_updated)
            }}. Please fix immediately!!      \n{%- endfor %}\n"
        alias: Defined MESSAGE FIELD
      - action: script.notification_dispatcher
        metadata: {}
        data:
          message: '{{message}}'
          title: '{{alert_name}}'
          notification_channel:
          - iPhone
          - alexa
          - persistant
          sound: default
          alexa_volume: Normal Volume
          alexa_sound: buzzers_pistols_01
          mobile_callback: '{{resolved.event_uid}}'
      - alias: START TIMER IF NEEDED
        if:
        - condition: template
          value_template: '{{ controlling_timer_state== ''idle'' }}'
        then:
        - action: logbook.log
          data:
            name: ALERT REPLACEMENT
            message: 'Starting Timer: Alert controlling

              {{resolved.controlling_binary_sensor}}

              ({{controlling_sensor_state|upper}}) | Timer

              {{resolved.controlling_timer }}

              ({{controlling_timer_state|upper}})

              '
            entity_id: '{{ resolved.controlling_binary_sensor }}'
        - action: timer.start
          target:
            entity_id: '{{ resolved.controlling_timer }}'
          data:
            duration:
              hours: 0
              minutes: '{{repeat_minutes|int}}'
              seconds: 0
      alias: If CONTROLLER IS ON, send notification, start timer if needed
    - conditions:
      - condition: template
        value_template: '{{ bool( controlling_sensor_state,false ) == false and  bool(controlling_timer_state
          in [''active'',''paused''],false) }}'
      sequence:
      - action: logbook.log
        data:
          name: ALERT REPLACEMENT
          message: 'Canceling Timer: Alert | Controller

            {{resolved.controlling_binary_sensor}}

            ({{controlling_sensor_state|upper}}) | Timer

            {{resolved.controlling_timer }}

            ({{controlling_timer_state|upper}})

            '
          entity_id: '{{ resolved.controlling_binary_sensor }}'
        enabled: true
      - action: timer.cancel
        target:
          entity_id: '{{ resolved.controlling_timer }}'
      - action: script.notification_dispatcher
        metadata: {}
        data:
          message: clear_notification
          title: '{{alert_name}}'
          notification_channel:
          - iPhone
          - alexa
          - persistant
          sound: default
          alexa_volume: Normal Volume
          alexa_sound: buzzers_pistols_01
          mobile_callback: '{{resolved.event_uid}}'
        alias: Clear Notification
      alias: CONTROLLER IS OFF AND  TIMER IS ACTIVE
    - conditions:
      - alias: IF POSIBLE ERROR STATE
        condition: template
        value_template: '{{bool(error,false)}}'
      sequence:
      - action: logbook.log
        data:
          name: INSERT TITLE
          message: Possible error state. Doc issues.
          entity_id: '{{ resolved.controlling_binary_sensor }}'
        enabled: true
    enabled: true
    default:
    - action: logbook.log
      data:
        name: INSERT TITLE
        message: MISSED ALL CATCHES, need trace.
        entity_id: '{{ resolved.controlling_binary_sensor }}'
      enabled: true
  alias: Alert Replacement Script UI
  description: 'The core functionality is a pairing of an alert state binary_sensor
    and a timer entity. It then runs on a cycle and sends notifications. Todo remove
    testing defaults. '
  fields:
    alert_name:
      name: Title
      selector:
        text:
      required: true
      default: 'WARNING Alert: Irregular_off'
    label_id:
      name: Label ID
      selector:
        text:
      required: true
      default: entity_list_aquarium_group_switch
    notification_timer:
      name: Notification Timer
      selector:
        entity:
          filter:
          - domain:
            - timer
          multiple: false
      default: timer.notification_warn_irregular_off
      required: true
    controlling_binary_sensor:
      name: Controlling Binary Sensor
      selector:
        entity:
          filter:
          - domain:
            - binary_sensor
            - input_boolean
          multiple: false
      default: binary_sensor.alert_state_warn_irregular_off
      required: true
    alert_type:
      name: Alert Type
      selector:
        select:
          options:
          - INFO
          - WARNING
          - CRITICAL
          - TEST
      default: WARNING
      required: true
    event_uid:
      name: Event UID
      description: For actionable notificcations and clearing example- ACK_WARN_IRREGULAR_OFF
      selector:
        text:
      required: true
      default: ACK_WARN_IRREGULAR_OFF
    trigger_state:
      selector:
        text:
      name: Trigger State
      description: like alert.state="on" in alert integration exccept idk message
        field
    repeat_minutes:
      selector:
        number:
          min: 2
          max: 500
          step: 1
      name: Repeat Minutes
      description: like "repeat" in alert integration
      required: true
      default: 5
tv_remote_volume_2:
  sequence:
  - variables:
      cmd: '{{ "VolumeUp" if ( command is not defined ) else command }}'
      value: '{{ ( states(''input_number.tv_remote_volume'') | int )  if ( units is
        not defined ) else ( units | int )}}'
  - action: remote.send_command
    metadata: {}
    data:
      num_repeats: '{{value}}'
      command: '{{cmd}}'
      device: TV
      delay_secs: 0.4
    target:
      entity_id: remote.infrared_rf_remote_control
  fields:
    command:
      selector:
        select:
          options:
          - VolumeUp
          - VolumeDown
      name: Command
      default: VolumeUp
    units:
      selector:
        number:
          min: 1
          max: 12
          step: 1
      name: Units
  alias: TV Remote Volume
  description: ''
set_speaker_volume:
  sequence:
  - variables:
      _max: '{{ 100 / ( 100 if (max is not defined) else max ) | int  }}'
      __inc: '{{ ( 10 if ( step is not defined) else step ) | int }}'
      _inc: '{{ (100 / __inc ) if (__inc > 0 ) else 0 }}'
    alias: define variables defaults
  fields:
    value:
      selector:
        number:
          min: 0
          max: 100
          step: 1
      default: 1
      name: Value
    step:
      selector:
        number:
          min: 0
          max: 20
          step: 1
      name: Step
      default: 10
    max:
      selector:
        number:
          min: 1
          max: 100
          step: 1
      name: Maximum Volume
      default: 100
  alias: Set Speaker Volume
  description: ''
roku_test:
  sequence:
  - action: media_player.play_media
    target:
      entity_id: '{{target_roku_player.entity_id}}'
    data:
      extra:
        content_id: '{{ youtube_video_id }}'
        media_type: live
      media:
        media_content_id: '837'
        media_content_type: app
        metadata: {}
  alias: Roku Youtube
  description: ''
  fields:
    target_roku_player:
      selector:
        target:
          entity:
            domain: media_player
      default:
        device_id: 1d0d30246ff51d6991e9662ddbeb7a25
    youtube_video_id:
      selector:
        text:
      name: YouTube Video ID
      required: true
bird_camera:
  sequence:
  - action: script.roku_test
    metadata: {}
    data:
      target_roku_player:
        entity_id: media_player.little_tv_bitch
      youtube_video_id: fLf9GPm2vIc
  alias: Bird Camera
  description: ''
dump_group:
  alias: Dump Group Members
  description: 'Log all members of groups or single entities.

    '
  fields:
    entities:
      description: List of entities to process.
      required: true
      selector:
        entity:
          multiple: true
  sequence:
  - repeat:
      for_each: '{{ entities }}'
      sequence:
      - data:
          name: Group Dump
          message: "{%- set state = states[repeat.item] %} {%- if 'entity_id' in state.attributes
            %}\n  {%- set members = state.attributes.entity_id %}\n  {{ state.name
            }} ({{ repeat.item }}) members: {{ members | count }}\n{%- for m in members
            %}\n  - {{ states[m].name if m in states else m }} ({{ m }}): {{ states[m].state
            if m in states else 'unknown' }}\n{%- endfor %} {%- else %}\n  {{ state.name
            }} ({{ repeat.item }}): {{ state.state }}\n{%- endif %}"
          entity_id: '{{ repeat.item }}'
        action: logbook.log
set_state_switch_light_test_version:
  sequence:
  - variables:
      use_trigger: '{{ bool( entity_trigger is defined , false ) }}'
      bool_invert: '{{ bool(bool_invert_state,false) }}'
      valid_trigger_value: '{{-  bool(use_trigger, false )  and bool(states( entity_trigger.entity_id
        ) in [''on'',''off'' ], false )  -}}'
      valid_select_value: '{{-  bool(use_trigger, false ) == false  and bool( select_state
        | lower in [''on'',''off'' ], false )  -}}'
      exec_rest: '{{- bool( ( bool( use_trigger, false ) and  bool(valid_trigger_value,
        false ) ) or ( bool( use_trigger, false ) == false and  bool(valid_select_value,
        false ) ),false) -}}'
      target_list: '{{ [] if (target_entity_set is not defined ) else target_entity_set.entity_id
        if target_entity_set.entity_id is list else [target_entity_set.entity_id]
        }}'
      result:
        action_called: false
        action: undefined
        trigger_state: undefined
        trigger_entity_id: undefined
        target_entity_id: undefined
        invert: '{{bool(bool_invert,false)}}'
  - alias: if executing the script
    if:
    - condition: template
      value_template: '{{ bool ( exec_rest,false )}}'
    then:
    - repeat:
        for_each: '{{ target_list }}'
        sequence:
        - variables:
            default_domain: switch
            target_entity: '{{ repeat.item }}'
            use_target: '{{ target_entity is defined and target_entity is string and
              is_state(target_entity, [''on'', ''off'']) }}'
            domain: "{%- if use_target and target_entity is string and '.' in target_entity
              -%}\n  {{ target_entity.split('.')[0] }}\n{%- else -%}\n  {{ default_domain
              }}\n{%- endif %}"
            pre_state: "{%- if bool(use_trigger, false ) -%}\n  {%- if bool(states(
              entity_trigger.entity_id ) in ['on' ], false ) -%}on{%- else -%}off{%-
              endif -%}\n{%- else -%}{{- select_state | lower -}}{%- endif  -%}"
            the_state: "{%- if bool(bool_invert, false ) -%}\n  {%- if bool( pre_state
              \ in ['on' ], false ) -%}off{%- else -%}on{%- endif -%}\n{%- else -%}{{pre_state}}{%-
              endif  -%}"
            action: '{{- domain }}.turn_{{- the_state }}'
            logbook_message: '''{% if use_target %}Going to call action {{ action
              }} on {{ state_attr( target_entity, "friendly_name" ) }} {% else %}
              not calling action because NO target has been selected{% endif %}''

              '
            result:
              action_called: '{{ bool( use_target , false) }}'
              action: '{{action}}'
              trigger_state: '{{the_state}}'
              trigger_entity_id: "{%- if bool(use_trigger, false ) -%}\n  {{ entity_trigger.entity_id
                }}\n{%- else -%}manual{%- endif -%}"
              target_entity_id: "{% if use_target %}\n  {{ target_entity }}\n{%- else
                -%}false{%- endif -%}"
              logbook_message: '{{logbook_message}}'
          alias: 'todo: fix result variable'
        - alias: if trigger is being used
          if:
          - condition: template
            value_template: '{{ bool(use_trigger,false) }}'
            alias: if using manually selected state
          then:
          - action: logbook.log
            metadata: {}
            data:
              name: 'State: {{ the_state | upper }} '
              message: '{{ logbook_message }}'
              entity_id: '{{ entity_trigger.entity_id }}'
            enabled: true
          else:
          - action: logbook.log
            metadata: {}
            data:
              name: Manually selected {{ the_state | upper }}
              message: '{{logbook_message}}'
          enabled: true
        - alias: if target is set, call the action.
          if:
          - condition: template
            value_template: '{{ bool(use_target,false) }}'
          then:
          - action: '{{ action }}'
            metadata: {}
            data: {}
            target:
              entity_id:
              - '{{ target_entity }}'
            enabled: true
    else:
    - variables:
        the_state: "{%- if bool(use_trigger, false ) -%}\n  {{ states(entity_trigger.entity_id
          )}}\n{%- else -%}{{- select_state | lower -}}{%- endif  -%}"
        logbook_message: '''Script Execution is STOPPED, trigger state is INVALID
          and set to {{ the_state }}''

          '
        result:
          action_called: false
          action: undefined
          trigger_state: '{{the_state}}'
          trigger_entity_id: "{%- if bool(use_trigger, false ) -%}\n  {{ entity_trigger.entity_id
            }}\n{%- else -%}manual{%- endif -%}"
          target_entity_id: "{% if use_target %}\n  {{ target_entity_set.entity_id
            }}\n{%- else -%}undefined{%- endif -%}"
          logbook_message: '{{logbook_message}}'
    - alias: action NOT being called
      if:
      - condition: template
        value_template: '{{ bool(use_trigger,false) }}'
      then:
      - action: logbook.log
        metadata: {}
        data:
          name: 'Invalid State: {{ the_state | upper }} '
          message: '{{ logbook_message }}'
          entity_id: '{{entity_trigger.entity_id}}'
        enabled: true
      else:
      - action: logbook.log
        metadata: {}
        data:
          name: 'Manually selected: {{ the_state | upper }} '
          message: '{{logbook_message}}'
    enabled: true
  - stop: '{% if exec_rest %}Action call complete{% else %}Action NOT called{% endif
      %}'
    response_variable: result
    enabled: true
  alias: Set State Switch/Light TEST VERSIOn
  fields:
    target_entity_set:
      selector:
        target:
          entity:
            domain:
            - switch
            - light
      name: Target Entity to Set State
      required: true
      description: 'todo: handle multiple targets'
    entity_trigger:
      selector:
        target:
          entity:
            domain:
            - binary_sensor
            - schedule
            - switch
            - light
            - input_boolean
      name: Entity State to use as trigger
      required: false
      description: Entity to mock trigger from (like time of day sensor, schedule)
    select_state:
      selector:
        select:
          options:
          - 'On'
          - 'Off'
          - Unavailable
          - Unknown
      name: State
      description: Set the target's state directly. Not used if a trigger entity is
        selected (like time of day sensor, schedule)
      required: true
      default: 'Off'
    bool_invert_state:
      selector:
        select:
          options:
          - 'On'
          - 'Off'
      name: Invert State
      description: Negates on and off states to toggle
      default: 'Off'
      required: false
  description: Target to turn on or off (setting the state)
  icon: mdi:toggle-switch-off
entity_info_loop_script:
  alias: Entity Info Loop Script
  mode: parallel
  fields:
    entities:
      name: Entities
      description: List of entity IDs
      required: true
      selector:
        entity:
          multiple: true
  sequence:
  - variables:
      input_entities: '{{ entities }}'
      results: []
  - repeat:
      for_each: '{{ input_entities }}'
      sequence:
      - variables:
          e: '{{ repeat.item }}'
          ent_obj: '{{ states(e) }}'
          ent_name: '{{ state_attr(e, ''friendly_name'') or e }}'
          ent_state: '{{ ent_obj.state }}'
          ent_domain: '{{ e.split(''.'')[0] }}'
          dev_id: '{{ device_id(e) }}'
          dev_name: "{% if dev_id %}\n  {{ device_attr(e, 'name')\n     or device_attr(e,
            'model')\n     or 'Unknown Device' }}\n{% else %}\n  none\n{% endif %}\n"
          ar_id: "{% if dev_id %}\n  {{ area_id(dev_id) }}\n{% else %}\n  {{ area_id(e)
            }}\n{% endif %}\n"
          ar_name: "{% if ar_id %}\n  {{ area_name(ar_id) }}\n{% else %}\n  none\n{%
            endif %}\n"
          lbls: '{{ device_attr(e, ''labels'') or [] }}'
          row: "{{\n  {\n    \"entity_id\": e,\n    \"name\": ent_name,\n    \"state\":
            ent_state,\n    \"domain\": ent_domain,\n    \"device_id\": dev_id,\n
            \   \"device_name\": dev_name,\n    \"area_id\": ar_id,\n    \"area_name\":
            ar_name,\n    \"labels\": lbls\n  }\n}}\n"
      - variables:
          results: '{{ results + [row] }}'
  - event: entity_info_list_return
    event_data:
      items: '{{ results }}'
  description: ''
issue_queue_command:
  alias: Issue Queue Command
  mode: parallel
  sequence:
  - variables:
      queue: '{{ states(''input_text.issue_queue'') | from_json(default=[]) }}'
      cid: '{{ issue_id }}'
      idx: "{% set i = -1 %} {% for item in queue %}\n  {% if item.id == cid %}\n
        \   {% set i = loop.index0 %}\n  {% endif %}\n{% endfor %} {{ i }}\n"
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ command == ''create'' and idx == -1 }}'
      sequence:
      - variables:
          issue: "{{\n  {\n    \"id\": cid,\n    \"summary\": summary or cid,\n    \"details\":
            details or \"\",\n    \"active\": true,\n    \"tags\": tags or [],\n    \"updated\":
            now()\n  }\n}}\n"
          new_queue: '{{ queue + [issue] }}'
      - data:
          entity_id: input_text.issue_queue
          value: '{{ new_queue | to_json }}'
        action: input_text.set_value
      - event: issue_queue_event
        event_data:
          action: create
          issue: '{{ issue }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''update'' and idx != -1 }}'
      sequence:
      - variables:
          issue: "{{\n  queue[idx] | combine({\n    \"summary\": summary or queue[idx].summary,\n
            \   \"details\": details or queue[idx].details,\n    \"tags\": tags or
            queue[idx].tags,\n    \"updated\": now()\n  })\n}}\n"
          new_queue: '{{ queue[:idx] + [issue] + queue[idx+1:] }}'
      - data:
          entity_id: input_text.issue_queue
          value: '{{ new_queue | to_json }}'
        action: input_text.set_value
      - event: issue_queue_event
        event_data:
          action: update
          issue: '{{ issue }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''resolve'' and idx != -1 }}'
      sequence:
      - variables:
          issue: "{{\n  queue[idx] | combine({\n    \"active\": false,\n    \"updated\":
            now()\n  })\n}}\n"
          new_queue: '{{ queue[:idx] + [issue] + queue[idx+1:] }}'
      - data:
          entity_id: input_text.issue_queue
          value: '{{ new_queue | to_json }}'
        action: input_text.set_value
      - event: issue_queue_event
        event_data:
          action: resolve
          issue: '{{ issue }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''remove'' and idx != -1 }}'
      sequence:
      - variables:
          new_queue: '{{ queue | rejectattr(''id'',''equalto'',cid) | list }}'
      - data:
          entity_id: input_text.issue_queue
          value: '{{ new_queue | to_json }}'
        action: input_text.set_value
      - event: issue_queue_event
        event_data:
          action: remove
          id: '{{ cid }}'
    - conditions:
      - condition: template
        value_template: '{{ command == ''exists'' }}'
      sequence:
      - event: issue_queue_event
        event_data:
          action: exists
          exists: '{{ idx != -1 }}'
          active: '{{ idx != -1 and queue[idx].active }}'
  - action: input_text.set_value
    metadata: {}
    target:
      entity_id: input_text.issue_queue
    data:
      value: 'i am a value '
  description: ''
  fields:
    field:
      selector:
        text:
      default: hello
    field_2:
      selector:
        text:
    command:
      name: Command
      description: Queue operation
      required: true
      selector:
        select:
          options:
          - create
          - update
          - resolve
          - remove
          - exists
    issue_id:
      selector:
        text:
      name: Issue ID
      description: 'this is a test '
      required: true
    summary:
      selector:
        text:
      name: summary
    details:
      selector:
        text:
          multiline: true
      name: Details
pump_cycle_every_2_hrs:
  sequence:
  - action: switch.turn_on
    data: {}
    target:
      entity_id: switch.120g_aquarium_filter
  - delay: 00:20:00
  - action: switch.turn_off
    data: {}
    target:
      entity_id: switch.120g_aquarium_filter
  - delay: 01:40:00
  - action: script.turn_on
    data: {}
    target:
      entity_id: script.pump_cycle_every_2_hrs
  alias: Pump cycle Every 2 hrs
  description: ''
pump_duty_cycle_on_off_loop:
  alias: Pump duty cycle (on/off loop)
  description: Turns a switch on for a duration, then off until the next interval,
    repeating.
  mode: restart
  fields:
    target_switch:
      name: Target switch
      description: Switch entity to control (smart plug or pump switch).
      required: true
      selector:
        entity:
          domain: switch
    on_duration:
      name: On duration
      description: How long to keep it ON each cycle.
      required: true
      default:
        hours: 0
        minutes: 20
        seconds: 0
      selector:
        duration:
          enable_day: false
          enable_millisecond: false
    repeat_interval:
      name: Repeat interval
      description: Total time from one ON start to the next ON start.
      required: true
      default:
        hours: 2
        minutes: 0
        seconds: 0
      selector:
        duration:
          enable_day: false
          enable_millisecond: false
  sequence:
  - variables:
      on_s: '{{ on_duration.hours * 3600 + on_duration.minutes * 60 + on_duration.seconds
        }}'
      interval_s: '{{ repeat_interval.hours * 3600 + repeat_interval.minutes * 60
        + repeat_interval.seconds }}'
      off_s: '{{ [interval_s - on_s, 0] | max }}'
  - repeat:
      while:
      - condition: template
        value_template: 'true'
      sequence:
      - target:
          entity_id: '{{ target_switch }}'
        action: switch.turn_on
      - delay:
          seconds: '{{ on_s }}'
      - target:
          entity_id: '{{ target_switch }}'
        action: switch.turn_off
      - delay:
          seconds: '{{ off_s }}'
new_script:
  sequence:
  - type: turn_off
    device_id: caa78ec93f1558ce2be969a1774afdf9
    entity_id: 84cf5a7007a8e688033cd7a432389630
    domain: switch
  fields:
    field:
      selector:
        duration:
          enable_day: true
          enable_millisecond: true
      default:
        hours: 0
        minutes: 20
        seconds: 0
      required: false
  alias: New script
  description: ''
issue_wueue_2:
  alias: Issue Queue 2
  description: Maintain a JSON issue queue stored in input_text.issue_queue
  mode: queued
  fields:
    action:
      name: Action
      description: add | update | remove | clear | list
      required: true
      selector:
        select:
          options:
          - add
          - update
          - remove
          - clear
          - list
    issue_id:
      name: Issue ID
      description: Unique issue identifier
      required: false
      selector:
        text:
          multiline: false
    summary:
      name: Summary
      required: false
      selector:
        text:
          multiline: false
    details:
      name: Details
      required: false
      selector:
        text:
          multiline: true
    severity:
      name: Severity
      required: false
      selector:
        select:
          options:
          - low
          - medium
          - high
          - critical
  variables:
    queue_entity: input_text.issue_queue
    queue_raw: '{{ states(queue_entity) | default(''[]'', true) }}'
    queue: "{% set s = queue_raw | trim %} {% if s in ['unknown', 'unavailable', 'none',
      ''] %}\n  []\n{% else %}\n  {{ s | from_json }}\n{% endif %}\n"
    v_action: '{{ action | default('''', true) | lower }}'
    v_issue_id: '{{ issue_id | default('''', true) | trim }}'
    v_summary: '{{ summary | default('''', true) | trim }}'
    v_details: '{{ details | default('''', true) | trim }}'
    v_severity: '{{ severity | default('''', true) | lower }}'
    now_iso: '{{ now().isoformat() }}'
    incoming_issue: '{% set obj = dict(issue_id=v_issue_id, updated_at=now_iso) %}
      {% if v_summary != '''' %}{% set obj = dict(obj, summary=v_summary) %}{% endif
      %} {% if v_details != '''' %}{% set obj = dict(obj, details=v_details) %}{%
      endif %} {% if v_severity != '''' %}{% set obj = dict(obj, severity=v_severity)
      %}{% endif %} {{ obj }}

      '
    existing_index: "{% set idx = -1 %} {% for item in queue %}\n  {% if item is mapping
      and (item.get('issue_id','') == v_issue_id) %}\n    {% set idx = loop.index0
      %}\n  {% endif %}\n{% endfor %} {{ idx }}\n"
    new_queue: "{% if v_action == 'clear' %}\n  []\n{% elif v_action == 'list' %}\n
      \ {{ queue }}\n{% elif v_action in ['add','update','remove'] %}\n  {% if v_issue_id
      == '' %}\n    {{ queue }}\n  {% else %}\n    {% if v_action == 'remove' %}\n
      \     {{ queue | rejectattr('issue_id', 'equalto', v_issue_id) | list }}\n    {%
      elif v_action == 'add' %}\n      {% if existing_index | int >= 0 %}\n        {{
      queue }}\n      {% else %}\n        {{ queue + [incoming_issue] }}\n      {%
      endif %}\n    {% elif v_action == 'update' %}\n      {% if existing_index |
      int < 0 %}\n        {{ queue + [incoming_issue] }}\n      {% else %}\n        {%
      set out = [] %}\n        {% for item in queue %}\n          {% if loop.index0
      == (existing_index | int) %}\n            {% set merged = dict(item, **incoming_issue)
      %}\n            {% set out = out + [merged] %}\n          {% else %}\n            {%
      set out = out + [item] %}\n          {% endif %}\n        {% endfor %}\n        {{
      out }}\n      {% endif %}\n    {% endif %}\n  {% endif %}\n{% else %}\n  {{
      queue }}\n{% endif %}\n"
    should_write: '{{ v_action in [''add'',''update'',''remove'',''clear''] }}'
    affected_issue: "{% if v_issue_id == '' %}\n  {{ dict() }}\n{% else %}\n  {% for
      item in new_queue %}\n    {% if item is mapping and item.get('issue_id','')
      == v_issue_id %}\n      {{ item }}\n      {% break %}\n    {% endif %}\n  {%
      endfor %}\n{% endif %}\n"
  sequence:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ v_action in [''add'',''update'',''remove''] and v_issue_id
          == '''' }}'
      sequence:
      - event: issue_queue_event
        event_data:
          action: error
          error: missing_issue_id
          message: issue_id is required for add/update/remove
      - stop: missing issue_id
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ should_write }}'
      sequence:
      - action: input_text.set_value
        target:
          entity_id: '{{ queue_entity }}'
        data:
          value: '{{ new_queue | to_json }}'
  - event: issue_queue_event
    event_data:
      action: '{{ v_action }}'
      issue_id: '{{ v_issue_id }}'
      issue: '{{ affected_issue | default({}, true) }}'
      queue_length: '{{ new_queue | length }}'
      queue: '{{ new_queue }}'
