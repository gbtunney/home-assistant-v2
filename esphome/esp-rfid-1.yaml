# ============================================================
# DEVICE — NFC/RFID Reader (PN532, I2C)
# ============================================================
#
# Role:
# - NFC/RFID tag UID reading (PN532 via I2C)
# - Standard diagnostics
#
# ============================================================

substitutions:
  # Identity
  device_id: rfid_reader_1
  device_hostname: "rfid-reader-1"
  device_friendly_name: "Cat Fountain NFC"
  device_description: "PN532 NFC/RFID reader for cat fountain tags."
  ble_active_scan: true

packages:
  # Base + platform + fleet
  base: !include common/universal_base.yaml
  board: !include common/platforms/esp32.yaml
  fleet: !include fleets/nfc_reader.yaml
  # Network performance tweaks
  #net_perf: !include common/overrides/wifi_performance.yaml

  # ----------------------------------------------------------
  # CAPABILITIES
  # ----------------------------------------------------------
  diagnostics: !include common/capabilities/diagnostics.yaml
  ble: !include common/capabilities/bluetooth_proxy.yaml
  test_buttons: !include common/capabilities/test/system_buttons.yaml

# ----------------------------------------------------------
# RFID Reader - NFC
# ----------------------------------------------------------

# -------------------------------------------------
# Runtime state (internal only, NOT exposed to HA)
# -------------------------------------------------
globals:
  - id: last_seen_uid
    type: std::string
    restore_value: false
    initial_value: '""' # empty = no tag present

# -------------------------------------------------
# I2C + PN532
# -------------------------------------------------
i2c:
  sda: 21
  scl: 22
  scan: true
  frequency: 50kHz # PN532 is more stable slower

pn532_i2c:
  id: pn532_board
  address: 0x24
  update_interval: 2s

  # Tag appeared
  on_tag:
    then:
      - if:
          condition:
            lambda: |-
              return id(last_seen_uid) != x;
          then:
            - lambda: |-
                id(last_seen_uid) = x;
            - logger.log:
                level: INFO
                format: "NFC TAG DETECTED (new): %s"
                args: ["x.c_str()"]
            - text_sensor.template.publish:
                id: nfc_uid
                state: !lambda "return x;"

  # Tag removed
  on_tag_removed:
    then:
      - lambda: |-
          id(last_seen_uid).clear();
      - logger.log:
          level: DEBUG
          format: "NFC tag removed"
      - text_sensor.template.publish:
          id: nfc_uid
          state: ""

# -------------------------------------------------
# Home Assistant–visible sensor
# -------------------------------------------------
text_sensor:
  - platform: template
    id: nfc_uid
    name: "Tag UID"
    update_interval: never
