substitutions:
  # =========================================================
  # Device-specific required variables (set in device file)
  # =========================================================
  device_id: "REQUIRED" # machine ID (internal)
  device_friendly_name: "REQUIRED" # human-friendly name
  device_description: "REQUIRED" # free text label
  log_level: "INFO" # DEBUG / VERBOSE / INFO

  # =========================================================
  # Fleet-specific — OVERRIDDEN in fleet templates
  # =========================================================
  fleet_id: "unassigned"
  fleet_firmware_version: "0.0.0"

esphome:
  name: ${device_id}
  friendly_name: ${device_friendly_name}
  comment: ${device_description}
  project:
    name: "${fleet_id}"
    version: "${fleet_firmware_version}"

logger:
  level: ${log_level}

# -----------------------------
# API + OTA shared defaults
# -----------------------------
api:
  id: ${device_id}_api
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    id: ${device_id}_ota
    password: !secret ota_password

# -----------------------------
# WiFi + Fallback AP
# -----------------------------
wifi:
  id: ${device_id}_wifi
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  ap:
    ssid: "${device_id}"
    password: !secret fallback_ap_password

captive_portal:

# -----------------------------
# BINARY SENSORS
# -----------------------------
binary_sensor:
  # Device Connectivity (built-in)
  - platform: status
    id: ${device_id}_status
    name: "${device_friendly_name} Connection Status"
    icon: mdi:lan-connect
    entity_category: diagnostic

  # Update Needed Logic (fleet-aware)
  - platform: template
    id: ${device_id}_update_needed
    name: "${device_friendly_name} Update Needed"
    icon: mdi:update
    device_class: update
    entity_category: diagnostic
    lambda: |-
      // Different fleet? → ignore updates
      if (strcmp("${esphome.project.name}", "${fleet_id}") != 0) {
        return false;
      }
      // Compare firmware versions
      return strcmp("${esphome.project.version}", "${fleet_firmware_version}") != 0;

# -----------------------------
# SENSORS — Diagnostics
# -----------------------------
sensor:
  # WiFi RSSI (dB)
  - platform: wifi_signal
    id: ${device_id}_wifi_signal_db
    name: "${device_friendly_name} WiFi Signal dB"
    icon: mdi:wifi
    update_interval: 600s
    entity_category: diagnostic
    disabled_by_default: true

  # WiFi Signal (%)
  - platform: copy
    id: ${device_id}_wifi_signal_percent
    source_id: ${device_id}_wifi_signal_db
    name: "${device_friendly_name} WiFi Signal %"
    icon: mdi:wifi
    unit_of_measurement: "%"
    entity_category: diagnostic
    filters:
      - lambda: |-
          if (x <= -100.0) return 0.0;
          if (x >= -50.0) return 100.0;
          return (x + 100.0) * 2.0;

  # Uptime Seconds
  - platform: uptime
    id: ${device_id}_uptime_seconds
    name: "${device_friendly_name} Uptime (s)"
    icon: mdi:timer-outline
    update_interval: 60s
    entity_category: diagnostic
    disabled_by_default: true

# -----------------------------
# TEXT SENSORS
# -----------------------------
text_sensor:
  # Human-readable uptime
  - platform: template
    id: ${device_id}_uptime_text
    name: "${device_friendly_name} Uptime"
    icon: mdi:clock-outline
    entity_category: diagnostic
    update_interval: 60s
    lambda: |-
      uint32_t seconds = id(${device_id}_uptime_seconds).state;
      uint32_t days = seconds / 86400;
      seconds %= 86400;
      uint32_t hours = seconds / 3600;
      seconds %= 3600;
      uint32_t minutes = seconds / 60;
      seconds %= 60;

      char buffer[32];
      snprintf(buffer, sizeof(buffer),
        "%ud %02uh %02um %02us",
        days, hours, minutes, seconds);
      return std::string(buffer);

  # Firmware Version (from ESPHome metadata)
  - platform: template
    id: ${device_id}_firmware_version
    name: "${device_friendly_name} Firmware Version"
    icon: mdi:chip
    entity_category: diagnostic
    update_interval: never
    lambda: |-
      return std::string("${esphome.project.version}");

  # Build Datetime
  - platform: template
    id: ${device_id}_build_datetime
    name: "${device_friendly_name} Build Datetime"
    icon: mdi:calendar-clock
    entity_category: diagnostic
    update_interval: never
    lambda: |-
      return std::string(__DATE__ " " __TIME__);

# -----------------------------
# BUTTONS
# -----------------------------
button:
  - platform: restart
    id: ${device_id}_restart
    name: "${device_friendly_name} Restart"
    icon: mdi:restart
    disabled_by_default: true
