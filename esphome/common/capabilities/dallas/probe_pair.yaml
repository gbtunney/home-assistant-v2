# ============================================================
# CAPABILITY — DALLAS PROBE PAIR
# ============================================================
#
# ENTITIES (PER PAIR, GENERIC)
# ---------------------------
# Sensors (enabled by default):
#   - <prefix>_<pair>a_temp        (smoothed temperature, probe A)
#   - <prefix>_<pair>b_temp        (smoothed temperature, probe B)
#
# Sensors (diagnostic, disabled by default):
#   - <prefix>_<pair>a_raw         (raw DS18B20, probe A)
#   - <prefix>_<pair>b_raw         (raw DS18B20, probe B)
#   - <prefix>_<pair>_delta        (|A − B|)
#
# Binary sensors:
#   - <prefix>_<pair>_high_alert   (either probe > high threshold)
#   - <prefix>_<pair>_low_alert    (either probe < low threshold)
#   - <prefix>_<pair>_out_of_sync  (delta > allowed)
#
# NOTES
# -----
# - <prefix> defaults to "probe" (configurable via substitutions)
# - <pair> is the pair_id (e.g. 1, 2, 3)
# - Entity names are TECHNICAL and STABLE
# - Home Assistant entity_ids are derived from `name:` and device name
# - Do NOT rename entities after first deploy
#
# FUTURE EXTENSIONS (INTENTIONALLY DEFERRED)
# ------------------------------------------
# These are explicitly NOT implemented in v1 to keep behavior stable.
# They are safe to add in future versions without breaking entity IDs:
#
# - Probe failure detection
#   * Detect NaN / disconnected DS18B20 sensors
#   * Expose <prefix>_<pair>a_failed / b_failed (diagnostic)
#
# - Per-probe calibration offsets
#   * User-defined additive offsets per probe
#   * Applied between raw and smoothed sensors
#
# - °F mirror sensors
#   * Additional Fahrenheit entities (disabled by default)
#   * Preserve existing °C entities as canonical
#
# - Health summary sensor
#   * Roll-up of connectivity, delta, and alert state
#   * Diagnostic-only, optional
#
# ============================================================
# ============================================================
# CAPABILITY — DALLAS PROBE PAIR (NO COPY PLATFORM)
# ============================================================

substitutions:
  probe_update_interval: "30s"
  probe_prefix: "probe"
  pair_id: "REQUIRED"

  probe_a_address: "REQUIRED"
  probe_b_address: "REQUIRED"

  pair_high_threshold: "32.0"
  pair_low_threshold: "22.0"
  pair_delta_threshold: "1.0"

# ------------------------------------------------------------
# PROBE A
# ------------------------------------------------------------
sensor:
  # Raw probe A (diagnostic)
  - platform: dallas_temp
    id: ${probe_prefix}_${pair_id}a_raw
    address: ${probe_a_address}
    name: "${probe_prefix} ${pair_id}A Raw Temperature"
    disabled_by_default: true
    update_interval: ${probe_update_interval}
    resolution: 12

  # Smoothed probe A (primary)
  - platform: dallas_temp
    id: ${probe_prefix}_${pair_id}a_temp
    address: ${probe_a_address}
    name: "${probe_prefix} ${pair_id}A Temperature"
    update_interval: ${probe_update_interval}
    resolution: 12
    device_class: temperature
    state_class: measurement
    filters:
      - sliding_window_moving_average:
          window_size: ${dallas_avg_window}
          send_every: ${dallas_avg_window}
          send_first_at: 1

  # ------------------------------------------------------------
  # PROBE B
  # ------------------------------------------------------------
  # Raw probe B (diagnostic)
  - platform: dallas_temp
    id: ${probe_prefix}_${pair_id}b_raw
    address: ${probe_b_address}
    name: "${probe_prefix} ${pair_id}B Raw Temperature"
    disabled_by_default: true
    update_interval: ${probe_update_interval}
    resolution: 12

  # Smoothed probe B (primary)
  - platform: dallas_temp
    id: ${probe_prefix}_${pair_id}b_temp
    address: ${probe_b_address}
    name: "${probe_prefix} ${pair_id}B Temperature"
    update_interval: ${probe_update_interval}
    resolution: 12
    device_class: temperature
    state_class: measurement
    filters:
      - sliding_window_moving_average:
          window_size: ${dallas_avg_window}
          send_every: ${dallas_avg_window}
          send_first_at: 1

  # ------------------------------------------------------------
  # DELTA (DIAGNOSTIC)
  # ------------------------------------------------------------
  - platform: template
    id: ${probe_prefix}_${pair_id}_delta
    name: "${probe_prefix} ${pair_id} Delta"
    icon: mdi:delta
    entity_category: diagnostic
    update_interval: ${probe_update_interval}
    lambda: |-
      if (isnan(id(${probe_prefix}_${pair_id}a_temp).state) ||
          isnan(id(${probe_prefix}_${pair_id}b_temp).state)) {
        return NAN;
      }
      return abs(
        id(${probe_prefix}_${pair_id}a_temp).state -
        id(${probe_prefix}_${pair_id}b_temp).state
      );

# ------------------------------------------------------------
# ALERTS
# ------------------------------------------------------------
binary_sensor:
  - platform: template
    id: ${probe_prefix}_${pair_id}_high_alert
    name: "${probe_prefix} ${pair_id} High Alert"
    device_class: heat
    lambda: |-
      return
        id(${probe_prefix}_${pair_id}a_temp).state > ${pair_high_threshold} ||
        id(${probe_prefix}_${pair_id}b_temp).state > ${pair_high_threshold};

  - platform: template
    id: ${probe_prefix}_${pair_id}_low_alert
    name: "${probe_prefix} ${pair_id} Low Alert"
    device_class: cold
    lambda: |-
      return
        id(${probe_prefix}_${pair_id}a_temp).state < ${pair_low_threshold} ||
        id(${probe_prefix}_${pair_id}b_temp).state < ${pair_low_threshold};

  - platform: template
    id: ${probe_prefix}_${pair_id}_out_of_sync
    name: "${probe_prefix} ${pair_id} Out of Sync"
    icon: mdi:alert-decagram
    entity_category: diagnostic
    lambda: |-
      return id(${probe_prefix}_${pair_id}_delta).state > ${pair_delta_threshold};
