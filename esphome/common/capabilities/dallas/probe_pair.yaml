# ============================================================
# CAPABILITY — DALLAS PROBE PAIR
# ============================================================
#
# ENTITIES (PER PAIR, GENERIC)
# ---------------------------
# Sensors (enabled by default):
#   - <prefix>_<pair>a_temp        (smoothed temperature, probe A)
#   - <prefix>_<pair>b_temp        (smoothed temperature, probe B)
#
# Sensors (diagnostic, disabled by default):
#   - <prefix>_<pair>a_raw         (raw DS18B20, probe A)
#   - <prefix>_<pair>b_raw         (raw DS18B20, probe B)
#   - <prefix>_<pair>_delta        (|A − B|)
#
# Binary sensors:
#   - <prefix>_<pair>_high_alert   (either probe > high threshold)
#   - <prefix>_<pair>_low_alert    (either probe < low threshold)
#   - <prefix>_<pair>_out_of_sync  (delta > allowed)
#
# NOTES
# -----
# - <prefix> defaults to "probe" (configurable via substitutions)
# - <pair> is the pair_id (e.g. 1, 2, 3)
# - Entity names are TECHNICAL and STABLE
# - Home Assistant entity_ids are derived from `name:` and device name
# - Do NOT rename entities after first deploy
#
# FUTURE EXTENSIONS (INTENTIONALLY DEFERRED)
# ------------------------------------------
# These are explicitly NOT implemented in v1 to keep behavior stable.
# They are safe to add in future versions without breaking entity IDs:
#
# - Probe failure detection
#   * Detect NaN / disconnected DS18B20 sensors
#   * Expose <prefix>_<pair>a_failed / b_failed (diagnostic)
#
# - Per-probe calibration offsets
#   * User-defined additive offsets per probe
#   * Applied between raw and smoothed sensors
#
# - °F mirror sensors
#   * Additional Fahrenheit entities (disabled by default)
#   * Preserve existing °C entities as canonical
#
# - Health summary sensor
#   * Roll-up of connectivity, delta, and alert state
#   * Diagnostic-only, optional
#
# ============================================================
# CAPABILITY — DALLAS PROBE PAIR (FINAL)
# Units: °C (canonical)
# Thresholds: 68–82 °F → 20.0–27.8 °C
# ESPHome 2025 SAFE
# ============================================================

substitutions:
  probe_update_interval: "60s"
  probe_prefix: ""
  pair_id: "REQUIRED"

  probe_a_address: "REQUIRED"
  probe_b_address: "REQUIRED"

  # Thresholds (°C)
  pair_low_threshold: "18.3" # 65°F
  pair_high_threshold: "27.8" # 82°F
  pair_delta_threshold: "1.0"

# ------------------------------------------------------------
# TEMPERATURE SENSORS
# ------------------------------------------------------------
sensor:
  # -------------------------
  # PROBE A — RAW
  # -------------------------
  - platform: dallas_temp
    id: ${probe_prefix}_${pair_id}a_raw
    address: ${probe_a_address}
    name: "${probe_prefix} ${pair_id}A Raw Temperature"
    icon: mdi:thermometer-lines
    disabled_by_default: true
    update_interval: ${probe_update_interval}
    resolution: 12

  # -------------------------
  # PROBE A — SMOOTHED
  # -------------------------
  - platform: dallas_temp
    id: ${probe_prefix}_${pair_id}a_temp
    address: ${probe_a_address}
    name: "${probe_prefix} ${pair_id}A Temperature"
    icon: mdi:thermometer
    device_class: temperature
    update_interval: ${probe_update_interval}
    resolution: 12
    filters:
      - sliding_window_moving_average:
          window_size: ${dallas_avg_window}
          send_every: ${dallas_avg_window}
          send_first_at: 1

  # -------------------------
  # PROBE B — RAW
  # -------------------------
  - platform: dallas_temp
    id: ${probe_prefix}_${pair_id}b_raw
    address: ${probe_b_address}
    name: "${probe_prefix} ${pair_id}B Raw Temperature"
    icon: mdi:thermometer-lines
    disabled_by_default: true
    update_interval: ${probe_update_interval}
    resolution: 12

  # -------------------------
  # PROBE B — SMOOTHED
  # -------------------------
  - platform: dallas_temp
    id: ${probe_prefix}_${pair_id}b_temp
    address: ${probe_b_address}
    name: "${probe_prefix} ${pair_id}B Temperature"
    icon: mdi:thermometer
    device_class: temperature
    update_interval: ${probe_update_interval}
    resolution: 12
    filters:
      - sliding_window_moving_average:
          window_size: ${dallas_avg_window}
          send_every: ${dallas_avg_window}
          send_first_at: 1

  # -------------------------
  # DELTA |A − B| (rounded)
  # -------------------------
  - platform: template
    id: ${probe_prefix}_${pair_id}_delta
    name: "${probe_prefix} ${pair_id} Delta"
    update_interval: ${probe_update_interval}
    filters:
      - round: 4
    device_class: temperature_delta
    icon: mdi:decagram
    disabled_by_default: true
    lambda: |-
      if (isnan(id(${probe_prefix}_${pair_id}a_temp).state) ||
          isnan(id(${probe_prefix}_${pair_id}b_temp).state)) {
        return NAN;
      }
      return fabs(
        id(${probe_prefix}_${pair_id}a_temp).state -
        id(${probe_prefix}_${pair_id}b_temp).state
      );

# ------------------------------------------------------------
# STATUS (ENUM-LIKE, HUMAN READABLE)
# ------------------------------------------------------------
text_sensor:
  - platform: template
    id: ${probe_prefix}_${pair_id}_status
    name: "${probe_prefix} ${pair_id} Status"
    icon: mdi:thermometer-alert
    update_interval: ${probe_update_interval}
    lambda: |-
      const float a = id(${probe_prefix}_${pair_id}a_temp).state;
      const float b = id(${probe_prefix}_${pair_id}b_temp).state;

      if (isnan(a) || isnan(b)) return std::string("unknown");

      if (a < ${pair_low_threshold} || b < ${pair_low_threshold})
        return std::string("COLD");

      if (a > ${pair_high_threshold} || b > ${pair_high_threshold})
        return std::string("HOT");

      return std::string("Normal");

# ------------------------------------------------------------
# ALERTS
# ------------------------------------------------------------
binary_sensor:
  - platform: template
    id: ${probe_prefix}_${pair_id}_out_of_sync
    name: "${probe_prefix} ${pair_id} Out of Sync"
    device_class: problem
    lambda: |-
      return id(${probe_prefix}_${pair_id}_delta).state > ${pair_delta_threshold};
